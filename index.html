<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORRYN-Psi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8D4B55">

    <script src="https://cdn.tailwindcss.com"></script>
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
        xintegrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
    <script 
        src="https://cdn.jsdelivr.net/npm/chart.js"
        integrity="sha256-Sckwe9uqsbnAAnwju3Yna2WqmdvjTkLqifGWIgW53Fk="
        crossorigin="anonymous"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F4F1DE; }
        .font-serif { font-family: 'Lora', serif; }
        .tab-button {
            border-bottom: 4px solid transparent;
            font-weight: 400;
            color: #6B7280;
            transition: all 0.2s;
            padding: 1rem 0.5rem;
        }
        .tab-button:hover { border-bottom-color: #D1D5DB; }
        .tab-button.active {
            border-bottom: 4px solid #8D4B55;
            font-weight: 700;
            color: #1C1C1C;
        }
        #historial-lista {
            max-height: 60vh;
            overflow-y: auto;
        }
        .radio-btn-container {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        .radio-btn-container input[type="radio"] {
            display: none;
        }
        .radio-btn-label {
            border: 2px solid #D1D5DB;
            border-radius: 0.75rem;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
        }
        .radio-btn-label:hover {
            border-color: #9CA3AF;
            background-color: #f9fafb;
        }
        .radio-btn-label .emoji {
            font-size: 2.25rem;
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .radio-btn-container input[type="radio"]:checked + .radio-btn-label {
            border-color: #8D4B55;
            box-shadow: 0 0 0 2px rgba(141, 75, 85, 0.4);
            background-color: #FCFBF4;
        }
        .radio-btn-container input[type="radio"][value="verde"]:checked + .radio-btn-label {
            border-color: #22C55E;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
        }
        #panel-manual h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #8D4B55;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        #panel-manual p, #panel-manual li {
            color: #374151;
        }
        #panel-manual ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #dashboard-period-filter .active-period {
            background-color: #8D4B55;
            color: white;
            font-weight: bold;
        }
        /* AI Summary Styles */
        #ai-summary-container {
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #8D4B55;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">

<div class="max-w-3xl mx-auto bg-[#FCFBF4] shadow-lg rounded-xl overflow-hidden">
    
    <div class="flex flex-wrap border-b border-gray-200 px-4 pt-4 md:px-8 md:pt-8 text-sm md:text-base">
        <button onclick="cambiarTab('registro')" id="tab-registro" class="tab-button flex-1 active">Registro</button>
        <button onclick="cambiarTab('historial')" id="tab-historial" class="tab-button flex-1">Historial</button>
        <button onclick="cambiarTab('dashboard')" id="tab-dashboard" class="tab-button flex-1">Dashboard</button>
        <button onclick="cambiarTab('perfil')" id="tab-perfil" class="tab-button flex-1">Perfil</button>
        <button onclick="cambiarTab('manual')" id="tab-manual" class="tab-button flex-1">Manual</button>
        <button onclick="cambiarTab('ajustes')" id="tab-ajustes" class="tab-button flex-1" aria-label="Ajustes">⚙️</button>
    </div>

    <div id="panel-registro" class="p-6 md:p-12">
        <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Registrar Momento</h1>
        <p class="text-gray-600 mb-8">Captura el momento actual. Tus datos se guardan solo en este dispositivo.</p>
        <form id="form-registro" onsubmit="guardarRegistro(event)" class="space-y-6">
            <div>
                <label for="fecha" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Fecha y hora</label>
                <input type="datetime-local" id="fecha" name="fecha" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-bold mb-2 text-[#1C1C1C]">Nivel de Alerta</label>
                <div class="radio-btn-container">
                    <input type="radio" id="alerta-verde" name="nivel_alerta" value="verde"><label for="alerta-verde" class="radio-btn-label"><span class="emoji">🟢</span><span class="text-xs font-semibold">Verde</span></label>
                    <input type="radio" id="alerta-amarillo" name="nivel_alerta" value="amarillo" checked><label for="alerta-amarillo" class="radio-btn-label"><span class="emoji">🟡</span><span class="text-xs font-semibold">Amarillo</span></label>
                    <input type="radio" id="alerta-naranja" name="nivel_alerta" value="naranja"><label for="alerta-naranja" class="radio-btn-label"><span class="emoji">🟠</span><span class="text-xs font-semibold">Naranja</span></label>
                    <input type="radio" id="alerta-rojo" name="nivel_alerta" value="rojo"><label for="alerta-rojo" class="radio-btn-label"><span class="emoji">🔴</span><span class="text-xs font-semibold">Rojo</span></label>
                </div>
            </div>
            <div>
                <label for="intensidad_emocional" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Intensidad Emocional: <span id="intensidad-valor">5</span>/10</label>
                <input type="range" id="intensidad_emocional" name="intensidad_emocional" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('intensidad-valor').textContent = this.value">
            </div>
            <div>
                <label for="claridad_mental" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Claridad Mental: <span id="claridad-valor">5</span>/10</label>
                <input type="range" id="claridad_mental" name="claridad_mental" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('claridad-valor').textContent = this.value">
            </div>
            <div>
                <label for="emocion_dominante" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Emoción Dominante</label>
                <input type="text" id="emocion_dominante" name="emocion_dominante" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ej: Alegría, Ansiedad, Gratitud..." required>
            </div>
            <div>
                <label for="detonante" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Detonante</label>
                <textarea id="detonante" name="detonante" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="¿Qué activó este momento?"></textarea>
            </div>
            <div>
                <label for="frase_mental" class="block text-sm font-bold mb-2 text-[#1C1C1C]">La Frase en mi Mente</label>
                <textarea id="frase_mental" name="frase_mental" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder='"Todo va a estar bien", "No soy suficiente"...'></textarea>
            </div>
            <div>
                <label for="notas" class="block text-sm font-bold mb-2 text-[#1C1C1C]">Notas adicionales</label>
                <textarea id="notas" name="notas" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Contexto, reflexiones, observaciones..."></textarea>
            </div>
            <div class="flex flex-col md:flex-row gap-3">
                <button type="submit" class="w-full py-4 rounded-lg font-bold text-white transition-all bg-[#8D4B55] hover:bg-[#7a3e48]">💾 Guardar Registro</button>
                <button type="button" onclick="generarRegistroPDF()" class="w-full py-4 rounded-lg font-bold text-[#8D4B55] bg-transparent border-2 border-[#8D4B55] hover:bg-[#8D4B55]/10 transition-all">📄 Exportar Último a PDF</button>
            </div>
            <p id="status-registro" class="text-sm text-center min-h-[20px]"></p>
        </form>
    </div>

    <div id="panel-historial" class="hidden p-6 md:p-12">
        <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Mi Historial</h1>
        <p class="text-gray-600 mb-8">Revisa tus registros pasados. La información está segura en tu dispositivo.</p>
        <div id="historial-lista" class="space-y-4"></div>
    </div>

    <div id="panel-dashboard" class="hidden p-6 md:p-12">
        <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Dashboard</h1>
        <p class="text-gray-600 mb-8">Visualiza patrones y tendencias de tus registros.</p>
        <div id="dashboard-content" class="space-y-6">
        </div>
        <div class="mt-8 space-y-4">
             <button onclick="generarReporteSemanal()" class="w-full py-4 rounded-lg font-bold text-[#8D4B55] bg-transparent border-2 border-[#8D4B55] hover:bg-[#8D4B55]/10 transition-all">📄 Generar Reporte Semanal en PDF</button>
             <button onclick="generarResumenIA()" class="w-full py-4 rounded-lg font-bold text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 transition-all">✨ Generar Resumen Semanal con IA</button>
             <p id="status-reporte" class="text-sm text-center min-h-[20px]"></p>
        </div>
        <div id="ai-summary-wrapper" class="mt-6 bg-white p-6 rounded-lg shadow-sm hidden">
            <h3 class="text-lg font-bold text-gray-700 mb-4">Resumen Semanal por IA</h3>
            <div id="ai-summary-container" class="text-gray-600"></div>
            <div id="ai-loader" class="text-center py-4 hidden">
                 <span class="loader"></span>
                 <p class="text-sm text-gray-500 mt-2">Analizando tus registros...</p>
            </div>
        </div>
    </div>

    <div id="panel-perfil" class="hidden p-6 md:p-12">
        <div id="perfil-vista" class="hidden">
             <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Mi Perfil</h1>
             <p class="text-gray-600 mb-8">Tu mapa fundacional. Actualízalo cuando sientas que has evolucionado.</p>
             <div id="perfil-contenido" class="space-y-4 text-sm bg-white p-6 rounded-lg shadow"></div>
             <div class="flex flex-col md:flex-row gap-3 mt-8">
                 <button onclick="editarPerfil()" class="w-full py-3 rounded-lg font-bold text-white bg-[#8D4B55] hover:bg-[#7a3e48]">✏️ Editar Perfil</button>
                 <button onclick="generarPerfilPDF()" class="w-full py-3 rounded-lg font-bold text-[#8D4B55] bg-transparent border-2 border-[#8D4B55] hover:bg-[#8D4B55]/10">📄 Generar PDF</button>
             </div>
             <p id="status-perfil-pdf" class="text-sm text-center min-h-[20px] mt-2"></p>
        </div>
        
        <div id="perfil-formulario">
            <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">ORRYN-Psi: Guía de Conversación Inicial (v1.1 - Edición Holística)</h1>
            <p class="text-gray-600 mb-8 italic">"Gracias por estar aquí. Las siguientes preguntas no son un examen, sino una invitación a explorar juntos el mapa de tu mundo interior. No hay respuestas correctas o incorrectas, solo las tuyas. Siente la libertad de tomarte tu tiempo y de ser tan abierto como te sientas cómodo."</p>
            <form id="form-perfil" onsubmit="guardarPerfil(event)" class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🗺️ Sección 1: Tu Contexto Personal</h2>
                    <p class="text-sm text-gray-600 mb-6 italic">Para entender mejor tu mapa, es útil conocer un poco del terreno en el que se ha formado. Siéntete libre de omitir cualquier pregunta con la que no te sientas cómodo.</p>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q1">Edad:</label><input type="text" id="q1" name="q1" class="w-full p-2 border border-gray-300 rounded"></div>
                        <div><label class="block text-sm font-bold mb-1" for="q2">Sexo Biológico Asignado al Nacer:</label><input type="text" id="q2" name="q2" placeholder="Ej: Masculino, Femenino, Intersexual" class="w-full p-2 border border-gray-300 rounded"></div>
                        <div><label class="block text-sm font-bold mb-1" for="q3">Identidad de Género:</label><input type="text" id="q3" name="q3" placeholder="¿Cómo te identificas? Ej: Hombre, Mujer, No-binario, etc." class="w-full p-2 border border-gray-300 rounded"></div>
                        <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded-md"><p><strong class="font-semibold">Una breve nota sobre las dos preguntas anteriores:</strong> El <strong>sexo biológico</strong> se refiere a las características físicas y biológicas ("el hardware"), mientras que la <strong>identidad de género</strong> es tu profundo sentido interno de ser tú mismo ("el software"). Entender ambas piezas nos ayuda a tener una imagen completa de tu experiencia vivida.</p></div>
                        <div><label class="block text-sm font-bold mb-1" for="q4">Orientación Afectiva/Sexual:</label><input type="text" id="q4" name="q4" class="w-full p-2 border border-gray-300 rounded"></div>
                        <div><label class="block text-sm font-bold mb-1" for="q5">Creencias o Marco Espiritual:</label><textarea id="q5" name="q5" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="Describe brevemente tu relación con la fe, la espiritualidad o tu filosofía de vida."></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q6">Núcleo Familiar/Hogar:</label><textarea id="q6" name="q6" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="Describe brevemente a las personas que componen tu hogar o núcleo familiar más cercano."></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q7">Vínculo Sentimental:</label><textarea id="q7" name="q7" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Actualmente, ¿hay alguna relación o interés romántico significativo en tu vida? Si la respuesta es sí y te sientes cómodo, ¿cómo describirías la esencia de esa conexión en una sola palabra? (Ejemplos: refugio, desafío, caos, ancla, crecimiento)."></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🌱 Sección 2: El Pasado - Las Raíces de tu Historia</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q8">Sobre los Momentos de Luz:</label><textarea id="q8" name="q8" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Piensa en un recuerdo, no importa cuán grande o pequeño, donde te sentiste genuinamente orgulloso, feliz o en paz contigo mismo. ¿Qué estaba sucediendo en ese momento?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q9">Sobre los Puntos de Inflexión:</label><textarea id="q9" name="q9" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Ahora, piensa en un momento que marcó un 'antes y un después' en tu vida. ¿Qué gran desafío o cambio enfrentaste y cómo sientes que te transformó?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q10">Sobre las Lecciones Forjadas:</label><textarea id="q10" name="q10" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Mirando esos momentos, tanto los de luz como los de desafío, ¿qué creencia fundamental sobre ti mismo o sobre la vida sientes que se forjó a partir de ellos?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q11">Sobre los Vínculos Primarios:</label><textarea id="q11" name="q11" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Pensando en las relaciones más importantes de tu infancia, ¿qué 'regla no escrita' sobre el amor, la seguridad o la confianza sientes que aprendiste y que quizás todavía aplicas en tu vida adulta?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🏞️ Sección 3: El Presente - Tu Ecosistema Personal</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q12">Sobre tu Ritmo Diario:</label><textarea id="q12" name="q12" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Describe el ritmo de un día típico para ti. ¿Cómo fluye tu energía desde que te levantas hasta que te acuestas?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q13">Sobre tus Pilares de Bienestar:</label><textarea id="q13" name="q13" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Qué actividades, rutinas o hábitos (como el ejercicio, la alimentación, el sueño, hobbies) sientes que son los pilares que sostienen tu bienestar en el día a día?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q14">Sobre el Apoyo Humano:</label><textarea id="q14" name="q14" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="El acompañamiento es a menudo un pilar fundamental. ¿Cuentas actualmente con algún tipo de apoyo profesional, como terapia psicológica, coaching o seguimiento psiquiátrico?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q15">Sobre la Medicación (Opcional):</label><textarea id="q15" name="q15" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="A veces, el apoyo químico es una herramienta valiosa. Si te sientes cómodo compartiéndolo, ¿utilizas actualmente alguna medicación para tu salud mental? Es de gran ayuda saber cuál o cuáles y sus dosis para entender el panorama completo. Esta información es completamente opcional y, por supuesto, libre de todo juicio."></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q16">Sobre Otras Sustancias (Opcional):</label><textarea id="q16" name="q16" rows="2" class="w-full p-2 border border-gray-300 rounded" placeholder="De manera similar, a veces recurrimos a otras sustancias para manejar momentos difíciles. Si te sientes cómodo, ¿has encontrado que alguna sustancia (como el alcohol, la marihuana, u otras) te sirve como herramienta para obtener algún efecto o beneficio en particular? Tu honestidad nos ayuda a entender mejor tus estrategias de afrontamiento y, al igual que todo lo demás, no será juzgada."></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🧭 Sección 4: El Cuerpo - Tu Brújula Física</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q17">Sobre la Conciencia Corporal:</label><textarea id="q17" name="q17" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Cuando sientes una emoción fuerte como la ansiedad o la alegría, ¿en qué parte de tu cuerpo la notas primero o con más intensidad? ¿Es una sensación de opresión, calor, ligereza, vacío?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q18">Sobre la Respuesta al Estrés:</label><textarea id="q18" name="q18" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Piensa en la última vez que te sentiste abrumado. Más allá del pensamiento, ¿qué le pasó a tu cuerpo? ¿Se aceleró tu corazón, sentiste tensión en los hombros, un nudo en el estómago, un impulso de querer huir?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q19">Sobre la Regulación Somática:</label><textarea id="q19" name="q19" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Independientemente de si funciona o no, ¿qué es lo primero que haces con tu cuerpo para intentar calmarte cuando te sientes mal? ¿Buscas acurrucarte, necesitas moverte y caminar, tensas los músculos?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🏃‍♂️ Sección 5: La Acción - Tus Patrones Conductuales</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q20">Sobre la Evitación Experiencial:</label><textarea id="q20" name="q20" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Qué tipo de situaciones, personas, lugares o incluso pensamientos tiendes a evitar a toda costa porque sabes que te generarán un profundo malestar?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q21">Sobre las Conductas de Seguridad:</label><textarea id="q21" name="q21" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Cuando te sientes inseguro o ansioso, ¿hay algún comportamiento o ritual que repites para sentir que tienes algo de control? (Ej: revisar las cosas varias veces, planificar en exceso, buscar la aprobación constante de otros)."></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q22">Sobre el Patrón de Procrastinación/Activación:</label><textarea id="q22" name="q22" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Qué tipo de tareas importantes para ti sueles posponer una y otra vez? ¿Qué emoción o pensamiento suele aparecer justo antes de que decidas posponerla?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🧠 Sección 6: La Arquitectura Mental - Los Planos de tu Mente</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q23">Sobre las Reglas y Supuestos:</label><textarea id="q23" name="q23" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Completa esta frase con lo primero que te venga a la mente: 'Para que los demás me valoren, debo ser siempre ______'. O esta otra: 'Si cometo un error, eso significa que soy ______'."></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q24">Sobre los Sesgos de Pensamiento:</label><textarea id="q24" name="q24" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Cuando algo sale mal, ¿tiendes a asumir la responsabilidad completa, incluso si no dependía de ti? O por el contrario, ¿tiendes a pensar que el mundo o la mala suerte están en tu contra?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q25">Sobre la Flexibilidad Cognitiva:</label><textarea id="q25" name="q25" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Piensa en una creencia muy arraigada que tengas sobre ti mismo. ¿Qué evidencia de tu vida podría poner en duda, aunque sea un poco, la veracidad absoluta de esa creencia?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🏙️ Sección 7: El Contexto - Tu Ecosistema Externo</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q26">Sobre el Entorno Laboral/Académico:</label><textarea id="q26" name="q26" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Describe tu entorno de trabajo o estudio. ¿Es un lugar que te nutre y te permite crecer, o es una fuente constante de estrés? ¿Qué dinámicas de poder o relación sientes que te afectan más?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q27">Sobre la Estabilidad y Seguridad:</label><textarea id="q27" name="q27" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Existen preocupaciones constantes en tu día a día sobre temas prácticos como la estabilidad financiera, la vivienda o tu seguridad personal? ¿Cómo crees que estas preocupaciones moldean tu estado de ánimo y tus decisiones?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q28">Sobre la Pertenencia Cultural/Social:</label><textarea id="q28" name="q28" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Sientes que encajas y perteneces a los grupos sociales o culturales que te rodean? ¿O sientes que tienes que esconder o adaptar partes importantes de ti mismo para ser aceptado?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">🌅 Sección 8: El Futuro y la Meta-Conciencia</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q29">Sobre tus Anhelos Profundos:</label><textarea id="q29" name="q29" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Si el miedo al fracaso y las limitaciones prácticas no existieran por un momento, ¿a qué dedicarías tu tiempo y tu energía? ¿Qué sueño secreto persigue tu corazón?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q30">Sobre tus Obstáculos:</label><textarea id="q30" name="q30" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Y por el contrario, ¿cuál es el miedo o la creencia más profunda que sientes que se interpone entre la persona que eres hoy y esa versión de ti que anhelas ser?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q31">Sobre los Patrones Recurrentes:</label><textarea id="q31" name="q31" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="¿Qué 'bucle' o patrón has notado que se repite una y otra vez en tu vida (en relaciones, trabajo, etc.), y qué crees que ese patrón está tratando de enseñarte?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q32">Sobre la Auto-compasión:</label><textarea id="q32" name="q32" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Si pudieras encontrarte con tu 'yo' de hace diez años, ¿qué consejo le darías con la sabiduría que tienes ahora? ¿Y qué consejo crees que tu 'yo' de dentro de diez años te daría a ti hoy?"></textarea></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold font-serif mb-4 text-[#8D4B55]">⚠️ Sección 9: Historial de Seguridad (Opcional)</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold mb-1" for="q33">Sobre el Diagnóstico Formal (Opcional):</label><textarea id="q33" name="q33" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="Si te sientes cómodo, ¿has recibido algún diagnóstico formal (de una condición psiquiátrica o crónica) por parte de un profesional de la salud?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q34">Sobre Autolesiones (Opcional):</label><textarea id="q34" name="q34" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="En momentos de dolor insoportable, a veces recurrimos a formas de hacernos daño. ¿Has tenido alguna vez experiencias con autolesiones?"></textarea></div>
                        <div><label class="block text-sm font-bold mb-1" for="q35">Sobre Ideación Suicida (Opcional):</label><textarea id="q35" name="q35" rows="3" class="w-full p-2 border border-gray-300 rounded" placeholder="De manera similar, ¿ha habido momentos en tu vida en los que hayas considerado terminarla o hayas intentado hacerlo?"></textarea></div>
                    </div>
                </div>
                <button type="submit" class="w-full py-4 rounded-lg font-bold text-white bg-[#8D4B55] hover:bg-[#7a3e48]">💾 Guardar Perfil</button>
                <p id="status-perfil" class="text-sm text-center min-h-[20px]"></p>
            </form>
             </div>
    </div>
    
    <div id="panel-manual" class="hidden p-6 md:p-12">
        <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Manual de Uso</h1>
        <p class="text-gray-600 mb-8">Una guía para acompañarte en tu proceso de introspección con ORRYN-Psi.</p>

        <h3>Bienvenido/a a ORRYN-Psi</h3>
        <p>Esta aplicación ha sido diseñada como un compañero de viaje personal y completamente privado. No es una herramienta de diagnóstico ni un sustituto de la terapia profesional, sino un espacio seguro para que puedas observar, registrar y comprender mejor tu mundo interior. La filosofía central es la <strong>auto-observación compasiva</strong>: la práctica de mirar nuestras experiencias internas sin juicio, con curiosidad y amabilidad.</p>

        <h3>La Privacidad es la Piedra Angular</h3>
        <p>Es fundamental que sepas esto: <strong>Toda la información que introduces en ORRYN-Psi se guarda exclusivamente en la memoria de tu dispositivo (teléfono, tablet o computadora).</strong> Nunca se envía a ningún servidor, nube o tercero. Tus datos son tuyos y de nadie más. La confianza y la seguridad son la base de un verdadero trabajo de introspección.</p>

        <h3>Cómo Usar las Secciones</h3>
        <p>Cada pestaña está diseñada para un propósito específico en tu camino de autoconocimiento.</p>
        <ul>
            <li><strong>Registro:</strong> Es el corazón de la aplicación. El objetivo es capturar "fotografías" de tus estados internos en momentos clave.
                <br><em>¿Cuándo usarlo?</em> Intenta hacerlo al menos una vez al día como un chequeo general. Es especialmente poderoso usarlo cuando sientes una emoción intensa (positiva o negativa) o te encuentras en medio de una situación difícil. No se trata de escribir un diario extenso, sino de capturar la esencia del momento.</li>
            <li><strong>Historial:</strong> Aquí es donde reside tu archivo personal. Al revisar tus entradas pasadas, puedes empezar a ver patrones que de otro modo pasarían desapercibidos.
                <br><em>Sugerencia:</em> Dedica un momento cada semana a desplazarte por tu historial. ¿Notas que ciertos detonantes se repiten? ¿Aparece la misma "frase mental" en diferentes contextos? ¿Hay un patrón en tu nivel de alerta en ciertos días de la semana?</li>
            <li><strong>Dashboard:</strong> Esta sección transforma tus registros en gráficos visuales, permitiéndote identificar tendencias y correlaciones de una manera intuitiva. Ahora incluye un gráfico de evolución para ver cómo cambian tu intensidad y claridad a lo largo del tiempo.</li>
            <li><strong>Perfil:</strong> Esta es tu base, tu "mapa del terreno". La Guía de Conversación Inicial no es algo que debas completar de una sola vez. Es una invitación profunda a la reflexión.
                <br><em>Recomendación:</em> Tómate tu tiempo. Responde a una sección por día o por semana. Sé honesto/a contigo mismo/a. Recuerda que este mapa no es estático; puedes y debes volver a editarlo a medida que creces y tu comprensión de ti mismo/a evoluciona.</li>
            <li><strong>Ajustes:</strong> Tu centro de control de datos.
                <ul>
                    <li><strong>Importar Datos:</strong> Te permite restaurar una copia de seguridad (un archivo `.json`) que hayas exportado previamente.</li>
                    <li><strong>Exportar Datos:</strong> Te permite crear una copia de seguridad de toda tu información en un archivo de formato `.json`. Es muy recomendable hacer esto periódicamente para no perder tus valiosos registros si cambias de dispositivo.</li>
                    <li><strong>Borrar Todos los Datos:</strong> Esta opción elimina de forma permanente e irrecuperable toda la información de la aplicación en tu dispositivo. Úsala con precaución.</li>
                </ul>
            </li>
        </ul>

        <h3>Un Último Consejo</h3>
        <p>Sé amable contigo mismo/a en este proceso. No hay registros "buenos" o "malos". Cada entrada es una pieza valiosa de información. El simple acto de detenerse a observar y nombrar lo que está sucediendo en tu interior ya es un paso inmenso hacia la claridad y el bienestar.</p>
    </div>

    <div id="panel-ajustes" class="hidden p-6 md:p-12">
        <h1 class="text-4xl font-bold font-serif mb-3 text-[#1C1C1C]">Ajustes</h1>
        <p class="text-gray-600 mb-8">Gestiona tus datos de forma segura.</p>
        <div class="space-y-4">
            <input type="file" id="import-file-input" accept=".json" class="hidden">
            <button onclick="importarDatos()" class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 transition-colors">📥 Importar Mis Datos (.json)</button>
            <button onclick="exportarDatos()" class="w-full py-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 transition-colors">📤 Exportar Mis Datos (.json)</button>
            <button onclick="borrarTodo()" class="w-full py-3 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700 transition-colors">🗑️ Borrar Todos los Datos</button>
        </div>
        <p id="status-ajustes" class="text-sm text-center min-h-[20px] mt-6"></p>
    </div>
</div>

<div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300">
    <div id="modal-content" class="bg-[#FCFBF4] rounded-xl shadow-2xl p-6 md:p-8 max-w-sm w-full transform transition-all duration-300 scale-95">
        <h3 class="text-xl font-bold font-serif text-[#1C1C1C] mb-4" id="modal-title">Confirmación</h3>
        <p class="text-gray-600 mb-6" id="modal-message">¿Estás seguro?</p>
        <div class="flex justify-end space-x-4">
            <button id="modal-cancel" class="px-6 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">Cancelar</button>
            <button id="modal-confirm" class="px-6 py-2 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700 transition-colors">Confirmar</button>
        </div>
    </div>
</div>

<script>
    // --- APP STATE ---
    let appState = {
        registros: [],
        perfil: {},
        iaConsent: false // New state for AI consent
    };
    // To hold the chart instances
    let doughnutChart = null; 
    let evolutionChart = null;

    // --- PROFILE QUESTIONS MAP ---
    const preguntasMapa = {
        's1': { title: '🗺️ Sección 1: Tu Contexto Personal', questions: {'q1':'Edad:', 'q2':'Sexo Biológico Asignado al Nacer:', 'q3':'Identidad de Género:', 'q4':'Orientación Afectiva/Sexual:', 'q5':'Creencias o Marco Espiritual:', 'q6':'Núcleo Familiar/Hogar:', 'q7':'Vínculo Sentimental:'}},
        's2': { title: '🌱 Sección 2: El Pasado - Las Raíces de tu Historia', questions: {'q8':'Sobre los Momentos de Luz:', 'q9':'Sobre los Puntos de Inflexión:', 'q10':'Sobre las Lecciones Forjadas:', 'q11':'Sobre los Vínculos Primarios:'}},
        's3': { title: '🏞️ Sección 3: El Presente - Tu Ecosistema Personal', questions: {'q12':'Sobre tu Ritmo Diario:', 'q13':'Sobre tus Pilares de Bienestar:', 'q14':'Sobre el Apoyo Humano:', 'q15':'Sobre la Medicación (Opcional):', 'q16':'Sobre Otras Sustancias (Opcional):'}},
        's4': { title: '🧭 Sección 4: El Cuerpo - Tu Brújula Física', questions: {'q17':'Sobre la Conciencia Corporal:', 'q18':'Sobre la Respuesta al Estrés:', 'q19':'Sobre la Regulación Somática:'}},
        's5': { title: '🏃‍♂️ Sección 5: La Acción - Tus Patrones Conductuales', questions: {'q20':'Sobre la Evitación Experiencial:', 'q21':'Sobre las Conductas de Seguridad:', 'q22':'Sobre el Patrón de Procrastinación/Activación:'}},
        's6': { title: '🧠 Sección 6: La Arquitectura Mental - Los Planos de tu Mente', questions: {'q23':'Sobre las Reglas y Supuestos:', 'q24':'Sobre los Sesgos de Pensamiento:', 'q25':'Sobre la Flexibilidad Cognitiva:'}},
        's7': { title: '🏙️ Sección 7: El Contexto - Tu Ecosistema Externo', questions: {'q26':'Sobre el Entorno Laboral/Académico:', 'q27':'Sobre la Estabilidad y Seguridad:', 'q28':'Sobre la Pertenencia Cultural/Social:'}},
        's8': { title: '🌅 Sección 8: El Futuro y la Meta-Conciencia', questions: {'q29':'Sobre tus Anhelos Profundos:', 'q30':'Sobre tus Obstáculos:', 'q31':'Sobre los Patrones Recurrentes:', 'q32':'Sobre la Auto-compasión:'}},
        's9': { title: '⚠️ Sección 9: Historial de Seguridad (Opcional)', questions: {'q33':'Sobre el Diagnóstico Formal (Opcional):', 'q34':'Sobre Autolesiones (Opcional):', 'q35':'Sobre Ideación Suicida (Opcional):'}}
    };

    // --- DATABASE MANAGER (INDEXEDDB) ---
    const dbManager = {
        db: null,
        init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('OrrynPsiDB', 2);
                request.onerror = (event) => reject("Error opening IndexedDB");
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('registros')) {
                        db.createObjectStore('registros', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('perfil')) {
                        db.createObjectStore('perfil', { keyPath: 'id' });
                    }
                };
            });
        },
        getData() {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['registros', 'perfil'], 'readonly');
                const registrosStore = transaction.objectStore('registros');
                const perfilStore = transaction.objectStore('perfil');
                let registros = [];
                let perfil = {};

                registrosStore.getAll().onsuccess = (event) => {
                    registros = event.target.result;
                };
                perfilStore.get('main').onsuccess = (event) => {
                    perfil = event.target.result ? event.target.result.data : {};
                };

                transaction.oncomplete = () => resolve({ registros, perfil });
                transaction.onerror = (event) => reject("Error in read transaction");
            });
        },
        addRegistro(registro) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['registros'], 'readwrite');
                const store = transaction.objectStore('registros');
                store.add(registro);
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject("Error adding record");
            });
        },
        deleteRegistro(id) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['registros'], 'readwrite');
                const store = transaction.objectStore('registros');
                store.delete(id);
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject("Error deleting record");
            });
        },
        savePerfil(perfilData) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['perfil'], 'readwrite');
                const store = transaction.objectStore('perfil');
                store.put({ id: 'main', data: perfilData });
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject("Error saving profile");
            });
        },
        clearAllData() {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['registros', 'perfil'], 'readwrite');
                transaction.objectStore('registros').clear();
                transaction.objectStore('perfil').clear();
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject("Error clearing data");
            });
        }
    };
    
    // --- APP INITIALIZATION & PWA SETUP ---
    window.onload = async () => {
        try {
            await setupPWA();
            await dbManager.init();
            const data = await dbManager.getData();
            appState.registros = data.registros || [];
            appState.perfil = data.perfil || {};
            // Load consent from localStorage
            appState.iaConsent = localStorage.getItem('iaConsent') === 'true';
            renderizarTodo();
            setInitialDateTime();
        } catch(e) { 
            console.error("Error initializing app:", e);
        }
    };
    
    async function setupPWA() {
        // Embed and Register Manifest
        const manifest = {
            "name": "ORRYN-Psi", "short_name": "ORRYN-Psi", "start_url": ".", "display": "standalone",
            "background_color": "#F4F1DE", "theme_color": "#8D4B55", "description": "Herramienta de introspección y registro emocional.",
            "icons": [{"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIiB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiI+PGcgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOEQ0QjU1IiBzdHJva2Utd2lkdGg9IjEyIj48cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIGQ9Ik0zMCA5NmMwLTM2LjQ0IDM1LjU3LTY2IDY2LTY2czY2IDI5LjU2IDY2IDY2YzAgMTIuODUtMy43MiAyNC44OC0xMC4yNyAzNC43N0wxMzMgMTYzbC0xOC0xMi0xOCAxMi0xOC0xMi0xOCAxMiAxLjI3LTMyLjIzQzMxLjcyIDEyMC44OCAzMCAxMDguODUgMzAgOTZaIi8+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNOTYgNjJ2NDIiLz48Y2lyY2xlIGN4PSI5NiIgY3k9IjEyNCIgcj0iNCIgZmlsbD0iIzhENEI1NSIvPjwvZz48L3N2Zz4=", "sizes": "192x192", "type": "image/svg+xml"},
                      {"src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+PGcgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOEQ0QjU1IiBzdHJva2Utd2lkdGg9IjI0Ij48cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIGQ9Ik04MCAyNTZjMC05Ny4xNyA5NC44Ni0xNzYgMTc2LTE3NnMxNzYgNzguODMgMTc2IDE3NmMwIDM0LjI2LTkuOTIgNjYuMzUtMjcuNCA5Mi43MkwzNzYgNDM1bC00OC0zMi00OCAzMi00OC0zMi00OCAzMmwyLjM4LTg1Ljk1QzkwLjk3IDMyMi4zNSA4MCAyODkuMjYgODAgMjU2WiIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTI1NiAxNjV2MTEyIi8+PGNpcmNsZSBjeD0iMjU2IiBjeT0iMzMwIiByPSIxMiIgZmlsbD0iIzhENEI1NSIvPjwvZz48L3N2Zz4=", "sizes": "512x512", "type": "image/svg+xml"}]};
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        document.querySelector('link[rel="manifest"]').setAttribute('href', URL.createObjectURL(manifestBlob));
    }

    // --- NAVIGATION & RENDERING ---
    const cambiarTab = (tab) => {
        ['registro', 'historial', 'dashboard', 'perfil', 'manual', 'ajustes'].forEach(t => {
            document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
            document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
        });
        if(tab === 'historial') renderizarHistorial();
        if(tab === 'dashboard') renderizarDashboard('all');
    };

    const renderizarTodo = () => { renderizarPerfil(); renderizarHistorial(); };
    
    const setInitialDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('fecha').value = now.toISOString().slice(0, 16);
    };

    const renderizarHistorial = () => {
        const lista = document.getElementById('historial-lista');
        const registrosOrdenados = [...appState.registros].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        if (registrosOrdenados.length === 0) {
            lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay registros aún.</p>';
            return;
        }
        const alertaEmoji = { verde: '🟢', amarillo: '🟡', naranja: '🟠', rojo: '🔴' };
        lista.innerHTML = registrosOrdenados.map(reg => `
            <div class="bg-white p-5 rounded-lg shadow-sm space-y-3">
                <div class="flex justify-between items-start">
                    <p class="font-bold text-sm text-[#8D4B55]">${new Date(reg.fecha).toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' })}</p>
                    <button onclick="eliminarRegistro(${reg.id})" class="text-gray-400 hover:text-red-500 p-1 -mt-1 -mr-1" aria-label="Eliminar registro">🗑️</button>
                </div>
                <div class="flex items-center gap-4 pt-2">
                    <span class="text-3xl">${alertaEmoji[reg.nivel_alerta] || '❓'}</span>
                    <div>
                        <p class="text-lg font-bold text-gray-800">${sanitizeHTML(reg.emocion_dominante || 'N/A')}</p>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600">
                            <span><strong>Intensidad:</strong> ${sanitizeHTML(reg.intensidad_emocional)}/10</span>
                            <span><strong>Claridad:</strong> ${sanitizeHTML(reg.claridad_mental)}/10</span>
                        </div>
                    </div>
                </div>
                ${reg.detonante ? `<div class="pt-2 border-t"><p class="text-xs font-bold text-gray-500 uppercase">Detonante</p><p class="text-sm text-gray-700 whitespace-pre-wrap">${sanitizeHTML(reg.detonante)}</p></div>` : ''}
                ${reg.frase_mental ? `<div class="pt-2 border-t"><p class="text-xs font-bold text-gray-500 uppercase">La Frase en mi Mente</p><p class="text-sm text-gray-700 whitespace-pre-wrap">${sanitizeHTML(reg.frase_mental)}</p></div>` : ''}
                ${reg.notas ? `<div class="pt-2 border-t"><p class="text-xs font-bold text-gray-500 uppercase">Notas Adicionales</p><p class="text-sm text-gray-700 whitespace-pre-wrap">${sanitizeHTML(reg.notas)}</p></div>` : ''}
            </div>`).join('');
    };

    const renderizarPerfil = () => {
        const tienePerfil = appState.perfil && Object.keys(appState.perfil).length > 0;
        document.getElementById('perfil-vista').classList.toggle('hidden', !tienePerfil);
        document.getElementById('perfil-formulario').classList.toggle('hidden', tienePerfil);
        if (tienePerfil) {
            const contenido = document.getElementById('perfil-contenido');
            contenido.innerHTML = Object.values(preguntasMapa).map(sec => {
                const respuestasHtml = Object.keys(sec.questions).map(qKey => {
                    const respuesta = appState.perfil[qKey];
                    return respuesta && respuesta.trim() ? `<p class="mb-2"><strong class="block text-xs uppercase">${sanitizeHTML(limpiarTextoParaPDF(sec.questions[qKey]))}</strong> ${sanitizeHTML(respuesta)}</p>` : '';
                }).join('');
                return respuestasHtml.trim() ? `<div class="mb-4 pb-2 border-b last:border-b-0"><h3 class="font-bold text-[#8D4B55] mb-2">${sanitizeHTML(limpiarTextoParaPDF(sec.title))}</h3>${respuestasHtml}</div>` : '';
            }).join('');
        }
    };
    
    const renderizarDashboard = (period = 'all') => {
        const container = document.getElementById('dashboard-content');
        if (appState.registros.length < 1) {
            container.innerHTML = `<div class="text-center py-12 bg-gray-50 rounded-lg"><p class="text-lg font-semibold text-gray-700">Aún no hay datos suficientes</p><p class="text-gray-500 mt-2">Crea algunos registros para ver tus estadísticas.</p></div>`;
            return;
        }

        const now = new Date();
        const periodDate = new Date();
        if (period !== 'all') {
            periodDate.setDate(now.getDate() - Number(period));
        }
        const filteredRecords = (period === 'all') 
            ? [...appState.registros]
            : appState.registros.filter(r => new Date(r.fecha) >= periodDate);

        const total = filteredRecords.length;
        const avgIntensidad = total > 0 ? (filteredRecords.reduce((sum, r) => sum + parseInt(r.intensidad_emocional, 10), 0) / total).toFixed(1) : 'N/A';
        const avgClaridad = total > 0 ? (filteredRecords.reduce((sum, r) => sum + parseInt(r.claridad_mental, 10), 0) / total).toFixed(1) : 'N/A';
        const alertaCounts = filteredRecords.reduce((acc, r) => {
            acc[r.nivel_alerta] = (acc[r.nivel_alerta] || 0) + 1;
            return acc;
        }, { verde: 0, amarillo: 0, naranja: 0, rojo: 0 });

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Total Registros</p><p class="text-3xl font-bold text-[#8D4B55]">${total}</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Intensidad Promedio</p><p class="text-3xl font-bold text-[#8D4B55]">${avgIntensidad}</p></div>
                <div class="bg-white p-4 rounded-lg shadow-sm"><p class="text-sm text-gray-500">Claridad Promedio</p><p class="text-3xl font-bold text-[#8D4B55]">${avgClaridad}</p></div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-bold text-center mb-4 text-gray-700">Distribución de Alertas</h3><div class="max-w-xs mx-auto"><canvas id="alertaChart"></canvas></div></div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                 <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-2">
                     <h3 class="text-lg font-bold text-gray-700 text-center sm:text-left">Evolución en el Tiempo</h3>
                     <div id="dashboard-period-filter" class="flex items-center border border-gray-200 rounded-lg text-sm self-center">
                         <button onclick="renderizarDashboard(7)" class="px-3 py-1 rounded-l-md hover:bg-gray-100 focus:outline-none ${period == 7 ? 'active-period' : ''}">7d</button>
                         <button onclick="renderizarDashboard(30)" class="px-3 py-1 hover:bg-gray-100 focus:outline-none border-l border-r ${period == 30 ? 'active-period' : ''}">30d</button>
                         <button onclick="renderizarDashboard('all')" class="px-3 py-1 rounded-r-md hover:bg-gray-100 focus:outline-none ${period == 'all' ? 'active-period' : ''}">Todo</button>
                     </div>
                 </div>
                 <div id="evolution-chart-container"><canvas id="evolutionChart"></canvas></div>
            </div>`;

        if (doughnutChart) doughnutChart.destroy();
        if (total > 0) {
            const ctxDoughnut = document.getElementById('alertaChart').getContext('2d');
            doughnutChart = new Chart(ctxDoughnut, {
                type: 'doughnut', data: { labels: ['Verde', 'Amarillo', 'Naranja', 'Rojo'], datasets: [{ label: 'Nivel de Alerta', data: [alertaCounts.verde, alertaCounts.amarillo, alertaCounts.naranja, alertaCounts.rojo], backgroundColor: ['#22C55E', '#FBBF24', '#F97316', '#EF4444'], borderColor: '#FCFBF4', borderWidth: 4 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' }}}
            });
        }
        
        if (evolutionChart) evolutionChart.destroy();
        if (filteredRecords.length > 1) {
            const sortedRecords = filteredRecords.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
            const ctxEvolution = document.getElementById('evolutionChart').getContext('2d');
            evolutionChart = new Chart(ctxEvolution, {
                type: 'line', data: { labels: sortedRecords.map(r => new Date(r.fecha).toLocaleDateString('es-ES', {month: 'short', day: 'numeric'})), datasets: [
                    { label: 'Intensidad', data: sortedRecords.map(r => r.intensidad_emocional), borderColor: '#EF4444', tension: 0.1, fill: false },
                    { label: 'Claridad', data: sortedRecords.map(r => r.claridad_mental), borderColor: '#3B82F6', tension: 0.1, fill: false }
                ]}, options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
            });
        } else {
            document.getElementById('evolution-chart-container').innerHTML = `<div class="text-center py-8 text-gray-500">Se necesitan al menos 2 registros en este período para mostrar la evolución.</div>`;
        }
    };

    // --- SAVE LOGIC ---
    const guardarRegistro = async (e) => {
        e.preventDefault();
        const form = e.target;
        const registro = Object.fromEntries(new FormData(form).entries());
        if (!registro.emocion_dominante.trim()) {
            showStatus('status-registro', '❌ Por favor, define la emoción dominante.', 'error'); return;
        }
        if (new Date(registro.fecha) > new Date()) {
            showStatus('status-registro', '❌ La fecha no puede ser en el futuro.', 'error'); return;
        }
        registro.id = Date.now();
        appState.registros.push(registro);
        try {
            await dbManager.addRegistro(registro);
            showStatus('status-registro', '✅ Guardado', 'success');
            form.reset(); setInitialDateTime();
            document.getElementById('intensidad-valor').textContent = '5';
            document.getElementById('claridad-valor').textContent = '5';
            document.getElementById('alerta-amarillo').checked = true; // Reset radio to default
        } catch (error) {
            showStatus('status-registro', '❌ Error al guardar. Intenta de nuevo.', 'error');
            appState.registros = appState.registros.filter(r => r.id !== registro.id);
        }
    };
    
    const guardarPerfil = async (e) => {
        e.preventDefault();
        const perfilData = Object.fromEntries(new FormData(e.target).entries());
        appState.perfil = perfilData;
        try {
            await dbManager.savePerfil(perfilData);
            showStatus('status-perfil', '✅ Perfil guardado', 'success', 1500);
            setTimeout(renderizarTodo, 1500);
        } catch(error) {
            showStatus('status-perfil', '❌ Error al guardar perfil.', 'error');
        }
    };

    const editarPerfil = () => {
        document.getElementById('perfil-vista').classList.add('hidden');
        document.getElementById('perfil-formulario').classList.remove('hidden');
        const form = document.getElementById('form-perfil');
        if (appState.perfil) {
            for (const key in appState.perfil) {
                if (form.elements[key]) form.elements[key].value = appState.perfil[key];
            }
        }
    };

    // --- UTILITIES ---
    const limpiarTextoParaPDF = (text) => {
        if (!text) return '';
        return text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
    };

    const sanitizeHTML = (str) => {
        if (!str) return '';
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
    };

    const showStatus = (elementId, message, type = 'info', duration = 3000) => {
        const statusEl = document.getElementById(elementId);
        statusEl.textContent = message;
        statusEl.style.color = type === 'error' ? '#DC2626' : '#16A34A';
        setTimeout(() => statusEl.textContent = '', duration);
    };

    // --- PDF GENERATION ---
    const generarRegistroPDF = () => {
        if (appState.registros.length === 0) {
            showStatus('status-registro', 'ℹ️ No hay registros para exportar.', 'info');
            return;
        }

        const ultimoRegistro = [...appState.registros].sort((a, b) => b.id - a.id)[0];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'p' });

        const PDF = {
            BG: '#FDFBF4', BORDER: '#D2B48C', TEXT: '#1C1C1C', FONT_H1: 16, FONT_H2: 10, FONT_P: 10,
            LINE_H: 1.4, MARGIN: 50, pageW: doc.internal.pageSize.getWidth(), pageH: doc.internal.pageSize.getHeight()
        };
        PDF.contentW = PDF.pageW - PDF.MARGIN * 2;
        let y = PDF.MARGIN;

        doc.setFillColor(PDF.BG);
        doc.rect(0, 0, PDF.pageW, PDF.pageH, 'F');

        doc.setFont('helvetica', 'bold').setFontSize(PDF.FONT_H1).setTextColor(PDF.TEXT);
        doc.text("Registro de Momento", PDF.pageW / 2, y, { align: 'center' });
        y += PDF.FONT_H1 * PDF.LINE_H;

        doc.setFont('helvetica', 'normal').setFontSize(PDF.FONT_P);
        doc.text(new Date(ultimoRegistro.fecha).toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' }), PDF.pageW / 2, y, { align: 'center' });
        y += (PDF.FONT_P * PDF.LINE_H) + 20;

        doc.setDrawColor(PDF.BORDER).setLineWidth(1).line(PDF.MARGIN, y, PDF.pageW - PDF.MARGIN, y);
        y += 25;

        const addEntry = (title, text) => {
            if (!text || !text.trim()) return;
            const titleWidth = 110;
            const textContentWidth = PDF.contentW - titleWidth;
            
            doc.setFont('helvetica', 'bold').setFontSize(PDF.FONT_H2).setTextColor(PDF.TEXT);
            doc.text(title, PDF.MARGIN, y, { baseline: 'top' });

            doc.setFont('helvetica', 'normal').setFontSize(PDF.FONT_P);
            const lines = doc.splitTextToSize(text, textContentWidth);
            doc.text(lines, PDF.MARGIN + titleWidth, y, { baseline: 'top' });

            const blockHeight = lines.length * PDF.FONT_P * PDF.LINE_H;
            y += blockHeight + 15; // Add vertical space after each entry
        };
        
        const alerta = ultimoRegistro.nivel_alerta;
        addEntry("Nivel de Alerta:", alerta.charAt(0).toUpperCase() + alerta.slice(1));
        addEntry("Emoción Dominante:", limpiarTextoParaPDF(ultimoRegistro.emocion_dominante));
        addEntry("Intensidad Emocional:", `${ultimoRegistro.intensidad_emocional} / 10`);
        addEntry("Claridad Mental:", `${ultimoRegistro.claridad_mental} / 10`);
        addEntry("Detonante:", ultimoRegistro.detonante);
        addEntry("La Frase en mi Mente:", ultimoRegistro.frase_mental);
        addEntry("Notas Adicionales:", ultimoRegistro.notas);

        doc.save(`ORRYN-Psi-Registro-${ultimoRegistro.id}.pdf`);
    };

    const generarPerfilPDF = () => {
        if (!appState.perfil || Object.keys(appState.perfil).length === 0) {
            showStatus('status-perfil-pdf', 'ℹ️ No hay perfil para exportar.', 'info');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'p' });

        const PDF = {
            BG: '#FDFBF4', BORDER: '#D2B48C', TEXT: '#1C1C1C', FONT_H1: 18, FONT_H2: 12, FONT_P: 10,
            LINE_H: 1.4, MARGIN: 50, pageW: doc.internal.pageSize.getWidth(), pageH: doc.internal.pageSize.getHeight()
        };
        PDF.contentW = PDF.pageW - PDF.MARGIN * 2;
        let y = PDF.MARGIN;

        const checkAddPage = (neededHeight) => {
            if (y + neededHeight > PDF.pageH - PDF.MARGIN) {
                doc.addPage();
                doc.setFillColor(PDF.BG).rect(0, 0, PDF.pageW, PDF.pageH, 'F');
                y = PDF.MARGIN;
            }
        };

        doc.setFillColor(PDF.BG).rect(0, 0, PDF.pageW, PDF.pageH, 'F');
        doc.setFont('helvetica', 'bold').setFontSize(PDF.FONT_H1).setTextColor(PDF.TEXT);
        doc.text("Perfil de Introspección ORRYN-Psi", PDF.pageW / 2, y, { align: 'center' });
        y += (PDF.FONT_H1 * PDF.LINE_H) + 15;
        
        for (const secKey in preguntasMapa) {
            const seccion = preguntasMapa[secKey];
            const respuestasSeccion = Object.keys(seccion.questions).filter(qKey => appState.perfil[qKey] && appState.perfil[qKey].trim());

            if (respuestasSeccion.length === 0) continue;

            checkAddPage((PDF.FONT_H2 * PDF.LINE_H) + 25);
            y += 15;
            doc.setDrawColor(PDF.BORDER).setLineWidth(1).line(PDF.MARGIN, y - 5, PDF.pageW - PDF.MARGIN, y - 5);
            doc.setFont("helvetica", "bold").setFontSize(PDF.FONT_H2).setTextColor(PDF.TEXT);
            doc.text(limpiarTextoParaPDF(seccion.title), PDF.MARGIN, y + PDF.FONT_H2, { baseline: 'top' });
            y += (PDF.FONT_H2 * PDF.LINE_H) + 10;

            for (const qKey of respuestasSeccion) {
                const pregunta = limpiarTextoParaPDF(seccion.questions[qKey]);
                const respuesta = appState.perfil[qKey];
                
                const questionLines = doc.splitTextToSize(pregunta, PDF.contentW);
                const answerLines = doc.splitTextToSize(respuesta, PDF.contentW);
                const blockHeight = (questionLines.length * PDF.FONT_P * PDF.LINE_H) + (answerLines.length * PDF.FONT_P * PDF.LINE_H) + 20;
                
                checkAddPage(blockHeight);

                doc.setFont("helvetica", "bold").setFontSize(PDF.FONT_P);
                doc.text(questionLines, PDF.MARGIN, y, { baseline: 'top' });
                y += (questionLines.length * PDF.FONT_P * PDF.LINE_H);

                doc.setFont("helvetica", "normal");
                doc.text(answerLines, PDF.MARGIN, y, { baseline: 'top' });
                y += (answerLines.length * PDF.FONT_P * PDF.LINE_H) + 18;
            }
        }
        
        doc.save("ORRYN-Psi-Perfil.pdf");
    };

    async function generarReporteSemanal() {
        const unaSemanaAtras = new Date();
        unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);

        const registrosSemana = appState.registros
            .filter(r => new Date(r.fecha) >= unaSemanaAtras)
            .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        if (registrosSemana.length === 0) {
            showStatus('status-reporte', 'ℹ️ No hay registros en los últimos 7 días.', 'info');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'p' });

        const PDF = {
            BG: '#FDFBF4', BORDER: '#D2B48C', TEXT: '#1C1C1C', FONT_H1: 18, FONT_H2: 12, FONT_P: 10,
            LINE_H: 1.4, MARGIN: 50, pageW: doc.internal.pageSize.getWidth(), pageH: doc.internal.pageSize.getHeight()
        };
        PDF.contentW = PDF.pageW - PDF.MARGIN * 2;
        let y = PDF.MARGIN;

        const checkAddPage = (neededHeight) => {
            if (y + neededHeight > PDF.pageH - PDF.MARGIN) {
                doc.addPage();
                doc.setFillColor(PDF.BG).rect(0, 0, PDF.pageW, PDF.pageH, 'F');
                y = PDF.MARGIN;
            }
        };

        // --- Cover Page ---
        doc.setFillColor(PDF.BG).rect(0, 0, PDF.pageW, PDF.pageH, 'F');
        doc.setFont('helvetica', 'bold').setFontSize(PDF.FONT_H1).setTextColor(PDF.TEXT);
        doc.text("Reporte Semanal ORRYN-Psi", PDF.pageW / 2, y, { align: 'center' });
        y += (PDF.FONT_H1 * PDF.LINE_H) * 2;
        doc.setFont('helvetica', 'normal').setFontSize(PDF.FONT_H2);
        const fechaInicio = unaSemanaAtras.toLocaleDateString('es-ES', { dateStyle: 'long' });
        const fechaFin = new Date().toLocaleDateString('es-ES', { dateStyle: 'long' });
        doc.text(`Periodo: ${fechaInicio} - ${fechaFin}`, PDF.pageW / 2, y, { align: 'center' });
        y += (PDF.FONT_H2 * PDF.LINE_H);
        doc.text(`Total de Registros: ${registrosSemana.length}`, PDF.pageW / 2, y, { align: 'center' });

        // --- Iterate through records ---
        for (const reg of registrosSemana) {
            checkAddPage(200); // Estimate height for a new entry section
            y += 40;
            doc.setDrawColor(PDF.BORDER).setLineWidth(1.5).line(PDF.MARGIN, y, PDF.pageW - PDF.MARGIN, y);
            y += 20;

            doc.setFont("helvetica", "bold").setFontSize(PDF.FONT_H2);
            doc.text(new Date(reg.fecha).toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' }), PDF.MARGIN, y);
            y += PDF.FONT_H2 * PDF.LINE_H;

            const addEntry = (title, text) => {
                if (!text || !text.trim()) return;

                const textLines = doc.splitTextToSize(text, PDF.contentW - 80);
                const neededHeight = (textLines.length * PDF.FONT_P * PDF.LINE_H) + 20;
                checkAddPage(neededHeight);

                doc.setFont("helvetica", "bold").setFontSize(PDF.FONT_P);
                doc.text(title, PDF.MARGIN, y, { baseline: 'top' });
                doc.setFont("helvetica", "normal");
                doc.text(textLines, PDF.MARGIN + 80, y, { baseline: 'top' });
                y += neededHeight - 5;
            };

            addEntry("Alerta:", (reg.nivel_alerta || 'N/A').replace(/^\w/, c => c.toUpperCase()));
            addEntry("Emoción:", limpiarTextoParaPDF(reg.emocion_dominante));
            addEntry("Intensidad:", `${reg.intensidad_emocional}/10`);
            addEntry("Claridad:", `${reg.claridad_mental}/10`);
            addEntry("Detonante:", reg.detonante);
            addEntry("Frase Mental:", reg.frase_mental);
            addEntry("Notas:", reg.notas);
        }

        const hoyStr = new Date().toISOString().split('T')[0];
        doc.save(`ORRYN-Psi_Reporte_Semanal_${hoyStr}.pdf`);
    }

    // --- NEW: AI SUMMARY GENERATION ---
    const generarResumenIA = async () => {
        if (!appState.iaConsent) {
            showModal(
                "Para generar el resumen, tus registros de la última semana se enviarán de forma anónima a la API de IA de Google para su análisis. Esta información no se almacena. ¿Estás de acuerdo?",
                () => {
                    appState.iaConsent = true;
                    localStorage.setItem('iaConsent', 'true');
                    hideModal();
                    procederConResumenIA();
                }
            );
            return;
        }
        procederConResumenIA();
    };

    const procederConResumenIA = async () => {
        const unaSemanaAtras = new Date();
        unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
        const registrosSemana = appState.registros.filter(r => new Date(r.fecha) >= unaSemanaAtras);
        
        const wrapper = document.getElementById('ai-summary-wrapper');
        const container = document.getElementById('ai-summary-container');
        const loader = document.getElementById('ai-loader');
        
        wrapper.classList.remove('hidden');
        container.innerHTML = '';
        loader.classList.remove('hidden');

        if (registrosSemana.length < 3) {
            container.innerHTML = 'Se necesitan al menos 3 registros en la última semana para generar un resumen significativo.';
            loader.classList.add('hidden');
            return;
        }

        const dataParaIA = registrosSemana.map(r => {
            return `Fecha: ${new Date(r.fecha).toLocaleDateString('es-ES')}\nEmoción: ${r.emocion_dominante}\nIntensidad: ${r.intensidad_emocional}/10\nDetonante: ${r.detonante || 'No especificado'}\nPensamiento: "${r.frase_mental || 'No especificado'}"\nNotas: ${r.notas || 'Ninguna'}`;
        }).join('\n---\n');

        const systemPrompt = "Actúa como un observador compasivo y reflexivo, similar a un terapeuta humanista. NO ERES UN ASISTENTE DE IA. Tu tono es cálido, gentil y curioso. No das diagnósticos ni consejos directos. Tu objetivo es ayudar al usuario a ver patrones en sus propios registros de diario emocional de una manera amable. Resume los patrones observados y finaliza siempre con una o dos preguntas abiertas y amables para la auto-reflexión. No uses un lenguaje clínico ni autoritario. Habla en segunda persona (tú). Sé conciso.";
        const userQuery = `He aquí mis registros emocionales de la última semana. Por favor, ayúdame a ver si hay algún patrón o tema recurrente. Sé gentil.\n\n${dataParaIA}`;
        
        try {
            const apiKey = ""; // Provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                container.textContent = text;
            } else {
                container.textContent = "No se pudo generar el resumen. La respuesta de la IA estaba vacía.";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            container.textContent = "Hubo un error al conectar con el servicio de IA. Por favor, inténtalo de nuevo más tarde.";
        } finally {
            loader.classList.add('hidden');
        }
    };

    // --- MODAL & CONFIRMATION ACTIONS ---
    const modal = document.getElementById('custom-modal');
    let confirmCallback = null;

    const showModal = (message, onConfirm) => {
        document.getElementById('modal-message').textContent = message;
        confirmCallback = onConfirm;
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95'), 10);
    };

    const hideModal = () => {
        document.getElementById('modal-content').classList.add('scale-95');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    document.getElementById('modal-confirm').addEventListener('click', () => { if(confirmCallback) confirmCallback(); });
    document.getElementById('modal-cancel').addEventListener('click', hideModal);

    const eliminarRegistro = (id) => {
        showModal('¿Estás seguro de que quieres eliminar este registro?', async () => {
            appState.registros = appState.registros.filter(r => r.id !== id);
            try { await dbManager.deleteRegistro(id); renderizarHistorial(); } 
            catch (error) { console.error("Error deleting from DB:", error); }
            hideModal();
        });
    };

    const exportarDatos = () => {
        const dataStr = JSON.stringify(appState, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `orryn-psi-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
        showStatus('status-ajustes', '✅ Datos exportados correctamente.', 'success');
    };
    
    const importarDatos = () => {
        document.getElementById('import-file-input').click();
    };

    document.getElementById('import-file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!importedData || typeof importedData.perfil !== 'object' || !Array.isArray(importedData.registros)) {
                    throw new Error("Invalid file format.");
                }

                showModal('Esto reemplazará todos los datos actuales. ¿Estás seguro de que quieres continuar?', async () => {
                    try {
                        await dbManager.clearAllData();
                        appState.perfil = importedData.perfil || {};
                        appState.registros = importedData.registros || [];
                        appState.iaConsent = importedData.iaConsent || false; // import consent state
                        localStorage.setItem('iaConsent', appState.iaConsent);
                        await dbManager.savePerfil(appState.perfil);
                        for (const registro of appState.registros) await dbManager.addRegistro(registro);
                        renderizarTodo(); cambiarTab('registro');
                        showStatus('status-ajustes', '✅ Datos importados con éxito.', 'success');
                    } catch(dbError) {
                        showStatus('status-ajustes', '❌ Error al guardar datos importados.', 'error');
                    }
                    hideModal();
                });
            } catch (error) {
                showStatus('status-ajustes', '❌ Error al leer el archivo. Asegúrate de que es un backup válido.', 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    });

    const borrarTodo = () => { 
        showModal('ADVERTENCIA: ¿Quieres eliminar TODOS tus datos de forma permanente?', () => {
            showModal('Esta acción NO se puede deshacer. ¿Confirmas la eliminación total?', async () => {
                appState = { registros: [], perfil: {}, iaConsent: false };
                localStorage.removeItem('iaConsent');
                try {
                    await dbManager.clearAllData();
                    renderizarTodo(); cambiarTab('registro');
                    showStatus('status-ajustes', 'Todos los datos han sido eliminados.', 'info');
                } catch(error) {
                    showStatus('status-ajustes', '❌ Error al borrar los datos.', 'error');
                }
                hideModal();
            });
        });
    };
</script>

</body>
</html>
