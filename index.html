const procederConResumenIA = async () => {
        const wrapper = document.getElementById('ai-summary-wrapper');
        const container = document.getElementById('ai-summary-container');
        const loader = document.getElementById('ai-loader');
        
        wrapper.classList.remove('hidden');
        container.innerHTML = '';
        loader.classList.remove('hidden');

        const unaSemanaAtras = new Date();
        unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
        const registrosSemana = appState.registros.filter(r => new Date(r.fecha) >= unaSemanaAtras);
        
        if (registrosSemana.length < 3) {
            container.innerHTML = 'Se necesitan al menos 3 registros en la última semana para generar un resumen significativo.';
            loader.classList.add('hidden');
            return;
        }

        const dataParaIA = registrosSemana.map(r => {
            return `Fecha: ${new Date(r.fecha).toLocaleDateString('es-ES')}\nEmoción: ${r.emocion_dominante}\nIntensidad: ${r.intensidad_emocional}/10\nDetonante: ${r.detonante || 'No especificado'}\nPensamiento: "${r.frase_mental || 'No especificado'}"`;
        }).join('\n---\n');

        const systemPrompt = "Actúa como un observador compasivo y reflexivo, similar a un terapeuta humanista. NO ERES UN ASISTENTE DE IA. Tu tono es cálido, gentil y curioso. No das diagnósticos ni consejos directos. Tu objetivo es ayudar al usuario a ver patrones en sus propios registros. Resume los patrones observados y finaliza siempre con una o dos preguntas abiertas para la auto-reflexión. Habla en segunda persona (tú). Sé conciso.";
        const userQuery = `He aquí mis registros emocionales de la última semana. Por favor, ayúdame a ver si hay algún patrón o tema recurrente.\n\n${dataParaIA}`;

        try {
            // Esta es la nueva llamada segura a nuestro "valet"
            const response = await fetch('/api/generate-summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userQuery, systemPrompt }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Error en la respuesta del servidor.');
            }

            const result = await response.json();
            container.textContent = result.summary;

        } catch (error) {
            console.error("Error calling serverless function:", error);
            container.textContent = "Hubo un error al conectar con el servicio de IA. Por favor, inténtalo de nuevo más tarde.";
        } finally {
            loader.classList.add('hidden');
        }
    };
